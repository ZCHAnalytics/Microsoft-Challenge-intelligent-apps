## AKS deployment pipeline with GitHub Actions
Scenario:  A video production company migrated its technology stack to AKS. To reduce time and effort building container images and deploying applications, we investigate using pipelines to deploy AKS workloads.

I need to design a pipeline that needs to trigger on two different events: 1) a tagged push to the main branch (to production) and 2) a non-tagged push to the main branch (to staging environment).
clone repo > build image > push to acr > deploy app > 

### 0. Set up Project Environment:
In the terminal, clone the GitHub Repo and inside it, run the init.sh file. The bash file did not specify the regions for all resources. So at first attempt, the resources were created across different in regions. 
The Dockerfile needed to be updated as well as nginx, node.js and hugo versions were out of date.

Checking the results with `az group list -o table` shows that all resources are now in the same region and status is 'succeeded'. The command `az acr list -o table` shows that Azure Container Registry has also been created. 

$ az group list -o table
Name                                                 Location    Status
---------------------------------------------------  ----------  ---------
NetworkWatcherRG                                     uksouth     Succeeded
mslearn-gh-pipelines-19117                           uksouth     Succeeded
MC_mslearn-gh-pipelines-19117_contoso-video_uksouth  uksouth     Succeeded
cloud-shell-storage-westeurope                       westeurope  Succeeded

$ az acr list -o table
NAME                           RESOURCE GROUP              LOCATION    SKU    LOGIN SERVER                              CREATION DATE         ADMIN ENABLED
-----------------------------  --------------------------  ----------  -----  ----------------------------------------  --------------------  ---------------
contosocontainerregistry29748  mslearn-gh-pipelines-19117  uksouth     Basic  contosocontainerregistry29748.azurecr.io  2024-04-03T19:15:37Z  True

### 1. Design staging pipeline
Now we create a pipeline by adding a new GitHub Actions workflow with file `build-staging.yml` and commit changes. The run failed because we haven't set up environmental variables as secrets in GitHub Actions yet.

`$ az acr list --query "[?contains(resourceGroup, 'mslearn-gh-pipelines')].loginServer" -o table`
I added them now: 

We create a new workflow in GitHub Actions, using templates from the marketplaces for designing steps - checkout, login. etc and commit changes.
This run will fail because no variables have been set in GitHub Secrets yet. 

Adding GitHub Secrets: 

We create  GitHub Actions staging pipeline by building the application image and pushing it to Azure Container Registry.
https://learn.microsoft.com/en-us/training/modules/aks-deployment-pipeline-github-actions/media/3-pipeline-5-deploy.png

Build-production.yml


trigger tag event - git pull
git tag -a v2.0.0 -m 'My first tag'
git push --tags
